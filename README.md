# HxM Logger - Логгер данных для Zephyr BioHarness/HxM

Этот скрипт Python считывает данные с Bluetooth-датчиков сердечного ритма Zephyr HxM (и, возможно, совместимых, таких как BioHarness), разбирает пакеты данных, обрабатывает переполнение счетчиков таймштампов R-событий и дистанции, и сохраняет временные ряды R-R интервалов, дистанции и скорости в CSV файл.

Скрипт использует поле `heartbeat_num` из протокола для надежного восстановления последовательности R-событий при пропуске пакетов Bluetooth.

## Возможности

*   Подключение к HxM/BioHarness через последовательный порт Bluetooth (RFCOMM/SPP).
*   Разбор бинарного протокола HxM (пакеты 0x26).
*   Проверка CRC8 пакетов.
*   Корректная обработка переполнения 8-битного счетчика `heartbeat_num`.
*   Корректная обработка переполнения 16-битного счетчика таймштампов R-событий.
*   Корректная обработка переполнения 16-битного счетчика дистанции (`distance`).
*   Расчет RR-интервалов в миллисекундах.
*   Расчет общей дистанции в метрах и мгновенной скорости в м/с.
*   Сохранение данных (таймштампы, RR-интервалы, дистанция, скорость) в CSV файл.

## Требования

*   Python 3.7+
*   Библиотека `pyserial`
*   Операционная система с поддержкой Bluetooth SPP (Serial Port Profile).
    *   **Linux:** Требуется пакет `bluez` или `bluez-utils`, утилита `rfcomm`.
    *   **Windows:** Требуется сопряжение устройства и определение назначенного ему COM-порта.
    *   **macOS:** Может потребоваться настройка последовательного порта Bluetooth.
*   Датчик Zephyr HxM или совместимый, сопряженный с компьютером.

## Установка

1.  **Клонируйте репозиторий:**
    ```bash
    git clone https://github.com/ВАШ_НИКНЕЙМ/ВАШ_РЕПОЗИТОРИЙ.git
    cd ВАШ_РЕПОЗИТОРИЙ
    ```

2.  **(Рекомендуется) Создайте и активируйте виртуальное окружение:**
    ```bash
    python -m venv venv
    # Linux/macOS:
    source venv/bin/activate
    # Windows:
    .\venv\Scripts\activate
    ```

3.  **Установите зависимости:**
    ```bash
    pip install -r requirements.txt
    ```

## Использование

1.  **Сопряжение и подключение Bluetooth:**
    *   Убедитесь, что ваш датчик HxM включен и сопряжен с вашим компьютером.
    *   **Linux:** Свяжите MAC-адрес устройства с виртуальным последовательным портом `rfcomm`:
        ```bash
        # Замените XX:XX:XX:XX:XX:XX на MAC-адрес вашего датчика
        sudo rfcomm bind /dev/rfcomm0 XX:XX:XX:XX:XX:XX 1
        ```
        Возможно, потребуется изменить `/dev/rfcomm0` на другой номер, если он занят. Убедитесь, что ваш пользователь имеет права на чтение/запись в `/dev/rfcomm0` (может потребоваться добавление в группу `dialout`: `sudo usermod -a -G dialout $USER`).
    *   **Windows:** После сопряжения найдите номер исходящего COM-порта, назначенного устройству HxM (в Диспетчере устройств или настройках Bluetooth).

2.  **Настройте порт в скрипте:**
    *   Откройте файл `hxm_logger.py`.
    *   Найдите строку `SERIAL_PORT = '/dev/rfcomm0'` в функции `main()`.
    *   Измените ее на ваш порт (например, `/dev/rfcomm0` для Linux, `COM3` или `COM4` для Windows).

3.  **Запустите скрипт:**
    ```bash
    python hxm_logger.py
    ```

4.  **Остановка и сохранение:**
    *   Нажмите `Ctrl+C`, чтобы остановить запись данных.
    *   Скрипт предложит ввести имя для CSV файла (или использовать имя по умолчанию с датой/временем).

## Формат CSV файла

Выходной CSV файл содержит следующие колонки:

*   `Corrected Timestamp (ticks)`: Развернутый таймштамп R-события в "тиках" (1 тик = 1/1024 секунды).
*   `Timestamp (s)`: Время R-события в секундах с начала отсчета устройства.
*   `RR Interval (ms)`: Интервал между текущим и предыдущим R-событием в миллисекундах.
*   `Distance (m)`: Общая накопленная дистанция в метрах на момент получения пакета, содержащего данное R-событие.
*   `Speed (m/s)`: Мгновенная скорость в м/с на момент получения пакета.

## Лицензия

Этот проект лицензирован под лицензией GNU General Public License v3.0 - смотрите файл [LICENSE](LICENSE) для подробностей.

## Благодарности

Благодарим изготовителя устройства за описание структуры пакетов в документации.
